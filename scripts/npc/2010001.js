/*
	名称：天空之城发型
	内容：更换发型和发色
*/

var status = -1;

// 所有男生发型
var mHair = new Array(
					/*30000,30020,30030,30040,30050,30060,30100,30110,30120,
					30130,30140,30150,30160,30170,30180,30190,30200,30210,
					30220,30230,30240,30250,*/30260,30270,30280,30290,30300,
					30310,30310,30320,30330,30340,30350,30360,30370,30380,
					30400,30410,30420,30430,30440,30450,30460,30470,30480,
					30490,30510,30520,30530,30540,30550,30560,30570,30590,
					30600,30610,30620,30630,30640,30650,30660,30670,30680,
					30700,30710,30720,30730,30740,30750,30760,30770,30780,
					30790,30800,30810,30820,30830,30840,30850,30860,30870,
					30880,30890,30900,30910,30920,30930,30940,30950,30990,

					33000,33030,33040,33050,33060,33070,33080,33090,33100,
					33110,33120,33130,33140,33150,33160,33170,33180,33190,
					33200,33210,33220,33230,33240,33260,33270,33280,33290,
					33300,33310,33320,33330,33340,33350,33360,33370,33380,
					33390,33400,33410,33430,33440,33450,33460,33470,33480,
					33500,33510,33520,33530,33540,33550,33580,33590,33600,
					33610,33620,33630,33640,33650,33660,33670,33680,33690,
					33700,33710,33720,33730,33740,33750,33760,33770,33780,
					33790,33800,33810,33820,33830,33930,33940,33950,33960,
					33970,33980,33990,

					35000,35010,35020,35030,35040,35050,35070,35090,35120,
					35130,35160,35170,35180,35220,35230,35240,35250,

					36000,36010,36020,36030,36040,36050,36070,36080,36090,
					36100,36110,36120,36130,36140,36150,36160,36170,36180,
					36190,36210,36220,36230,36240,36250,36290,36300,36310,
					36330,36340,36350,36360,36370,36380,36390,36400,36410,
					36420,36430,36440,36450,36460,36470,36480,36490,36510,
					36520,36530,36540,36550,36560,36570,36580,36590,36620,
					36630,36640,36650,36670,36680,36690,36700,36710,36720,
					36730,36740,36750,36760,36770,36780,36790,36800,36810,
					36820,36830,36840,36850,36860,36880,36890,36900,36920,
					36930,36940,36950,36980,36990
					);

// 所有女生发型
var fHair = new Array(
					/*31000,31010,31020,31030,31040,31050,31060,31070,31080,
					31090,31100,31110,31120,31130,31140,31150,31160,31170,
					31180,31190,31200,31210,31220,31230,31240,31250,31260,
					31270,31280,31290,31300,31310,31320,31330,31340,31350,
					31360,31370,31380,31400,31410,31420,31430,*/31440,31450,
					31460,31470,31480,31490,31510,31520,31530,31540,31550,
					31560,31590,31610,31620,31630,31640,31650,31660,31670,
					31680,31690,31700,31710,31720,31730,31740,31750,31760,
					31770,31780,31790,31800,31810,31820,31830,31840,31850,
					31860,31870,31880,31890,31900,31910,31920,31930,31940,
					31950,31990,32120,32130,32140,32150,32160,32440,32470,
					32490,32500,
					34000,34010,34040,34050,34060,34070,34080,34090,34100,
					34110,34120,34130,34140,34150,34160,34170,34180,34190,
					34200,34210,34220,34230,34240,34250,34260,34270,34280,
					34290,34300,34310,34320,34330,34340,34350,34360,34370,
					34380,34400,34410,34420,34430,34440,34450,34470,34480,
					34490,34510,34540,34560,34590,34600,34610,34620,34630,
					34640,34650,34660,34670,34680,34690,34700,34710,34720,
					34730,34740,34750,34760,34770,34780,34790,34800,34810,
					34820,34830,34840,34850,34860,34870,34880,34890,34900,
					34910,34940,34950,34960,34970,34990,
					37000,37010,37020,37030,37040,37050,37060,37070,37090,
					37100,37110,37120,37130,37140,37180,37190,37200,37210,
					37220,37230,37240,37250,37260,37280,37290,37300,37310,
					37320,37330,37340,37350,37370,37380,37400,37410,37420,
					37430,37440,37450,37460,37490,37500,37510,37520,37530,
					37540,37550,37560,37570,37580,37610,37620,37630,37640,
					37650,37660,37670,37680,37690,37700,37710,37720,37730,
					37740,37750,37760,37770,37780,37790,37800,37810,37820,
					37830,37840,37850,37860,37880,37890,37900,37920,37930,
					37940,37950,37960,37970,37980,37990,
					38000,38010,38020,38030,38040,38050,38060,38070,38080,
					38100,38120,38150,38160,38220,38240,38250,38260,38290,
					38320,38330,38340,38350,38360
					);
var card = new Array(
					5150052, // 万能高级美发卡
					5151036  // 万能高级染发卡
					);
var showhair; // 需要显示的发型的数组

// 记录玩家选择的服务，换发型还是换发色
var firstsel = -1;

// 脚本启动函数
function start() {
	action(1, 0, 0);
}

// 脚本执行函数，参数说明：模式，类型，选择的编号
function action (mode, type, selection) {
	if (mode == 0) { // 模式等于0时，为玩家退出NPC对话
		cm.dispose();
		return;
	} else { // 模式为1时，为玩家正在进行NPC对话
		// 页面自增，玩家操作一次对话时，action函数都会重新执行一次，但由于status是全局变量，所以这里的自增依然会有效。
		status++;
	}

	// 如果页面为0时，也就是第一页，开始进行代码处理，并显示第一页对话内容，同一页不能执行两个cm.send对话，否则客户端会卡死
	if (status == 0) {
		// 声明并初始化一个字符串变量，也就是显示在对话框内的内容
		var text = "您好，我是有名的理发师#p" + cm.getNpc() + "#，想变得更漂亮更帅气吗？来试试我的手艺吧！\r\n\r\n";
		text += "#b#L0# 改变发型\r\n";
		text += "#L1# 改变发色";

		// 调用对话函数，向玩家发送第一页对话内容
		cm.sendSimple(text);

	// 如果页面为1，处理并显示第二页的对话内容
	} else if (status == 1) {
		// 声明并初始化一个字符串变量，字符串是可以用加号连接的，可以加任何类型的变量，但要注意类型相加的含义。不能连接对象。
		// 下面字符串连接了一个 card[selection]，首先card在文件首部声明为全局数组变量，包含了两个元素。
		// selection 为玩家如果选择了改变发型，改变发型的选择编号在第一页对话函数内的编号为 #L0#，也就是0。
		// card的第0个元素为 5150052, // 万能高级美发卡
		// card的第1个元素为 5151036  // 万能高级染发卡
		// 这其实是一个用法技巧，你也可以直接将下面 card[selection] 替换为5150052之类的道具代码，但这样就会使缺乏灵活性，还得多加个判断，太麻烦
		var text = "选择您满意的发型吧，如果你有#b#t" + card[selection] + "##k的话，我可以帮你剪出你想要的发型。\r\n\r\n";

		// 声明一个新的变量，并判断玩家的性别，在服务端内，性别为0时代表男性，为1时代表女性。
		// 下面的 表达式 ? 变量1 : 变量2  含义为：问号前的表达式如果结果为真，Hair的值就等于变量1的值，否则为变量2的值
		var Hair = cm.getPlayer().getGender() == 0 ? mHair : fHair;

		// 声明一个空的数组，用于存放最终显示给玩家的所有发型
		showhair = new Array();
		
		// 如果玩家选择了换发型
		if (selection == 0) {
			// 记录玩家选择的服务为换发型，selection此时的值为0，你也可以直接写为 firstsel = 0;
			firstsel = selection;
			// 获取玩家当前的发型颜色，代码规律昨晚已经说过了。%10是取余数，所有发型代码除以10后的余数都是代码的个位数
			var currhaircolor = cm.getPlayerStat("HAIR") % 10;
			// 进行循环，如果i小于所有发型的数组成员数，则循环条件为真，比如数组成员数为10时，下面的代码就会循环10次
			for (var i = 0; i < Hair.length; i++) {
				// 每次循环都取出该下标的元素，简单说就是取出发型代码数组指定位置的代码，i是控制位置的，从0开始读取，直到循环完时也就已经把所有代码都加进新的数组内了
				// 发型代码加上颜色，之所以我们在换发型事，当前的头发是什么颜色，在列表内选择其他发型时就都是什么颜色。
				showhair[i] = Hair[i] + currhaircolor;
			}

		// 如果玩家选择了换发色
		} else if (selection == 1) {
			firstsel = selection;
			// 取当前发型的代码
			var currhairstyle = Math.floor(cm.getPlayerStat("HAIR")/10) * 10;
			// 循环8次，把当前发型的8种颜色都放进新的数组
			for (var i = 0; i < 8; i++) {
				showhair[i] = currhairstyle + i;
			}
		}
		
		// 调用特殊对话框，这个函数专门处理换发型、换肤色、换脸型的对话框。
		// 参数1为对话内容，参数2，需要显示给玩家的所有发型的数组，参数3，换发型就消耗美发卡，换发色就消耗染发卡
		cm.sendStyle(text, showhair, card[selection]);
	
	// 下面进入第三页对话
	} else if (status == 2) {
		// if()内的函数为服务端内部的函数，调用后传递两个参数，第一个参数为消耗哪种卡，第二个参数是从第二页所显示的发型内取出玩家最终选择的发型，selection就是选择的编号，但并不是发型的代码
		// 如果cm.setAvatar函数成功，就会返回1，否则返回0。一般是由于玩家身上没有卡的时候才会失败。
		if (cm.setAvatar(card[firstsel], showhair[selection < 0 ? (selection += 256) : selection]) == 1) {
			cm.sendOk("矮油，看看看看，太漂亮了有木有？");
                cm.worldSpouseMessage(0x25, "『洗剪吹』 :  " + cm.getChar().getName() + " 经过一番洗剪吹，时尚界又出了一位时尚达人，大家快来围观吧.");
		} else {
			cm.sendOk("你没有#b#t" + card[firstsel] + "##k，可以先去商城购买。");
		}
		// 所有对话已经完毕，调用这个函数来结束与该NPC的对话
		cm.dispose();
	}
}